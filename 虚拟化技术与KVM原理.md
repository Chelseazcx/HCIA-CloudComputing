# 虚拟化技术与KVM原理

## 虚拟化基础

### x86内存架构

主要以32位架构为例分析，最后添加x86-64架构下的内容。

**1.地址空间**

​	地址空间划分为物理地址空间和线性地址空间。

1. 物理地址空间

   物理地址空间的大小由CPU实现的物理地址位数决定。由CPU经过MMU转换后的外地址总线位数决定。外线地址总线位数与CPU处理数据的能力没有必然联系，16位的8086CPU有20位地址空间。

   为了让多个程序有效相互隔离，能有效使用物理地址空间的资源，引入线性地址空间。

2. 线性地址空间

   大小由CPU实现的线性地址位数决定，线性地址位数由CPU的内地址总线位数决定。内地址总线位数与CPU一致。如果是32位处理器，其线性地址空间为4GB。

   线性地址空间会被映射到某一部分物理地址空间或整个物理地址空间。在现代操作系统中，每个进程都拥有自己的私有线性地址空间。一个典型的线性地址空间构造：

    ![1578570978](resources\1578570978.jpg)

**2.地址**

地址是访问地址空间的索引。索引可以分为物理地址和线性地址。由于x86特殊的段机制，还有额外一种逻辑地址。

1. 逻辑地址

   是程序直接使用的地址。由一个16位的段选择符和一个32位的偏移量构成。

2. 线性地址

   线性地址又称虚拟地址。是逻辑地址转换后的结果，用于索引线性地址空间。当CPU使用分页机制时，还需要将线性地址转换成物理地址才能访问平台内存或其他物理设备。当分页机制未启用时，线性地址与物理地址相同。

3. 物理地址

   是物理地址空间的索引，是CPU提交到总线用于访问平台内存或其他硬件设备的最终地址。

物理地址与逻辑地址、线性地址的关系

- 分段机制启用，分页机制未启用：逻辑地址 - > 线性地址 = 物理地址
- 分段机制、分页机制同时启用：逻辑地址 - > 线性地址 - > 物理地址

**3.x86内存管理机制**

x86架构的内存管理机制分为两部分：分段机制和分页机制。

​	分段机制为程序提供彼此隔离的代码区域、数据区域、栈区域，从而避免同一处理器上运行多个程序互相影响。

​	分页机制实现传统的按需分页、虚拟内存机制。可以将程序的执行环境按需映射到物理内存。此外，分页机制还可以用于提供多任务的隔离。

1. 分段机制

   分段机制将内存分成以起始地址(Base)和长度(Limit)描述的块。段可以与程序最基本的元素联系起来，程序可以简单划分为代码段、数据段和栈，段机制就有相应的代码段、数据段和栈段。
   分段机制由逻辑地址、段选择符、段描述符和段描述符表4个基本部分结构。当程序使用逻辑地址访问内存时，CPU通过逻辑地址中的段选择符索引段描述符表，进而得到该内存对应的段描述符(段的基地址、长度和读/写、访问权限等信息)。根据属性信息检测访问是否合法。如果合法，再根据基地址将逻辑地址转换为线性地址。

   流程：

    ![1578571998(1)](resources\1578571998(1).jpg)

2. 段选择符

   段选择符是逻辑地址用于索引段描述符表，获取该段对应的段描述符。

    ![1578572066(1)](resources\1578572066(1).jpg)

   各字段含义：

   - 索引(Index)：段描述符表的索引；
   - TI：指明索引哪个段描述符表。TI = 0，表示索引全局段描述符表(GDT)；TI = 1，表示索引本地端描述符表(LDT)；
   - RPL：所要求的权限级别。存在于段选择器的0、1位，为程序访问增加一级检查。

   x86架构提供6个段寄存器存放当前各个段的段选择符。

   - CS(代码段)：存放代码段的段选择符；
   - DS(数据段)：存放数据段的段选择符；
   - SS(栈段)：存放栈的段选择符；
   - ES、FS、GS：存放额外三个数据段的段选择符，由程序自由使用。

   段寄存器的构造

   | 段寄存器名 | 段寄存器 |      程序不可见的段描述符寄存器       |
   | :---: | :--: | :----------------------: |
   |  CS   | 段选择器 | 段的基地址、长度、各种属性(读写属性、访问属性) |

3. 段描述符

    ![1578572566(1)](resources\1578572566(1).jpg)

   - Base字段描述该段的基地址；
   - Limit字段描述该段的长度；
   - DPL字段指明描述符权限级别，表示该段所具有的权限。

4. 段描述符表

   x86提供两种段描述符表：GDT和LDT

   - GDT是内存中的一个数据结构。可以将GDT看成一个数组，由基地址和长度描述。
   - LDT是一个短，需要用一个短描述符来描述。LDT的段描述符存放在GDT中。

   为了加速对GDT和LDT的访问，x86提供GDTR寄存器和LDTR寄存器。

   通过段选择符表索引GDT/LDT的过程

    ![1578573758(1)](resources\1578573758(1).jpg)

5. 逻辑地址转化线性地址

   在程序加载阶段，该进程LDT的段选择符表索引GDT，获得LDT的段描述符并将其加载到LDTR寄存器中。此外，该进程的CS、DS、SS被加载入相应的段选择符。CPU根据段选择符的TI字段索引相应的段描述符表，获得相应的段描述符，并加载入CS、DS、SS对应的不可见段描述符寄存器。

   1. 进行必要的属性、访问权限检查
   2. 从DS对应的段描述符寄存器获得该段的基地址
   3. 将变量的32位偏移量和段描述符中的基地址相加，获得该变量的线性地址

6. 分页机制

   在x86架构下，页的典型大小为4KB，一个4GB的虚拟地址空间被划分为1024 x 1024个页面。x86允许大于4KB的页面大小(2MB、4MB)。

   分页机制的核心是通过页表将线性地址转换为物理地址，并配合旁路转换缓冲区(TLB)加速地址转换的过程。分页机制主要由页表、CR3寄存器和TLB三个部件构成。

    ![1578574795(1)](resources\1578574795(1).jpg)

   1. 页表

      是用于将线性地址转换为物理地址的主要数据结构。一个地址对齐到页边界后的值称为页帧号。线性地址对应虚拟页帧号(VFN)，物理地址对应物理页帧号(PFN)。

      在保护模式下，x86使用两级转换方案，CR3指向一个4KB的页目录，页目录又分为1024个4KB大小的页表。最后页表分为1024个长为4KB的页。

      未启用PAE的4KB的页面

       ![1578575370(1)](resources\1578575370(1).jpg)

      - 页目录项(PDE)：包含页表的物理地址
      - 页表项(PTE)：包含该线性地址对应的PFN。

















































































