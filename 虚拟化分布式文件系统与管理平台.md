# 虚拟化分布式文件系统与管理平台

## 分布式文件系统

### DRBD

分布式复制块设备是基于Linux的开源软件。由内核模块和管理工具组成，通过网络进行块设备的同步镜像。数据写入本地的DRBD设备上的文件系统时，同时被发送到网络中的另外一台主机上。 ![1576648746(1)](https://github.com/orangehaswing/HCIA-CloudComputing/blob/master/resources/1576648746(1).jpg?raw=true)

**复制协议**

DRBD复制有三种协议

协议A：异步复制。本地写成功后立即返回，数据放在发送Buffer中，如果服务器掉电，数据可能丢失。

协议B：内存同步(半同步)复制协议。本地写成功并将数据发送到对方后立刻返回，如果双机掉电，数据可能丢失。

协议C：同步复制协议。本地和对方写成功确认后返回。如果磁盘同时损坏，数据可能丢失。

**使用方式**

- 主备模式：两台存储服务器，一主一备，主出现故障，备机顶替，同时只有一台服务器提供服务。
- 双主模式：两台存储服务器，同时提供服务，共同分担压力，当一台服务器故障的时候，服务器性能降低，但不会中断。

### GlusterFS

GlusterFS是一款全队成的开源分布式文件系统。采用弹性哈希算法，没有中心节点，所有的节点全部平等。

特性：

- 全队成架构，部署使用简单
- 弹性伸缩
- 支持Infiniband
- 支持通过SSL证书加密的数据同步
- 支持卷级别的压缩
- 支持FUSE
- 支持SMB
- 支持QEMU
- 支持NFS
- 支持Hadoop
- 与oVirt深度整合
- 支持OpenStack

GlusterFS重要概念：

- brick：GlusterFS的基本单元，以节点服务器目录形式展现
- 卷：多个brick的逻辑组合
- Metadata：元数据，关于数据的数据，用于描述文件、目录等信息
- FUSE：用户空间的文件系统，内核的特性，在用户态创建文件系统，而不需要修改内核
- GlusterFS服务器节点：数据存储服务器，GlusterFS只有两种服务器角色，一种是数据存储服务器，一种是客户端
- 客户端：使用GlusterFS存储服务的服务器
- Glusterd：GlusterFS服务，所有存储节点需要运行

### Sheepdog

Sheepdog是分布式对象存储系统，是完全对称的架构，没有元数据服务器，每个节点完全平等，主要特性如下：

- 只有两个服务，部署管理方便
- 性能和容量可以线性伸缩：当容量或者性能需要的时候，Sheepdog可以通过增加节点线性地进行扩展
- 没有单点故障：任何一个结点故障，数据都不会丢失
- 管理方便：没有专门的管理角色，当新的服务器增加并启动Sheepdog服务的时候，Sheepdog可以自动探测并加入存储系统
- QEMU原生支持所有镜像
- 灵活可选的冗余级别，可以基于集群、节点的多份镜像策略
- 支持镜像快照，克隆，大小调整，大小预分配，冗余策略调整，备份
- 支持集群级别的快照
- 支持虚拟机在线迁移
- 支持专用的网卡用于数据同步
- 被OpenStack支持
- 支持iSCIS，NBD，块设备方式提供存储服务

Sheepdog组件：

- 对象存储：固定大小的数据和全局唯一的标识。通过标识可以读取，写入，创建，删除对象存储。
- 网关：从QEMU驱动接收I/O请求，通过哈希算法计算目标节点，将I/O请求发送会目标节点
- 对象管理：管理网关接收I/O请求，并在自己的本地磁盘执行读/写操作
- 集群管理：管理节点成员，探测失败添加的节点，并且探知节点的变换，一些操作需要在所有节点之间同步
- QEMU块驱动：将虚拟机镜像切割为固定的块大小，默认是4MB，并通过网关将数据块存储在存储对象上。

**对象类型**

1. 数据对象：包含虚拟机实际的数据。访问的是这些镜像
2. vdi对象：虚拟磁盘的元数据，比如磁盘名字，磁盘尺寸，创建时间，数据对象ID等
3. 虚拟机状态对象：存储运行虚拟机镜像状态，在管理员创建在线快照的时候使用
4. vdi属性镜像：可以存储每个vdi属性，通过vdi属性镜像存储，属性是key-value形式

### MooseFS

MooseFS是支持容错的基于网络的分布式文件系统，将数据分布到多台物理机上，但是对外提供统一接口：

- 高可用，数据多份存储
- 动态扩展，可以在线添加机器和磁盘
- 文件可以在一定周期内回收
- 支持在线快照

MooseFS有四种角色：

- 管理节点：一台单一服务器，存储文件系统元数据
- 数据节点：多台服务器，存储数据
- 元数据备份服务器：可以有多台，存储元数据日志，并且周期性地从管理结点下载元数据文件，可以在管理结点故障的时候提示为管理节点
- 客户端：挂在使用MFS文件系统的服务器

## Ceph

### 简介

从架构上，Ceph的架构设计均衡，没有明显缺点。提供对象存储，块存储及文件存储的同一存储模型。

**Ceph主要特点**

- 统一存储
- 无任何单点故障
- 数据多份冗余
- 存储容量可扩展
- 自动容错及故障自愈

**三大角色和作用**

Ceph OSD：OSD守护进程，主要功能包括：存储数据、副本数据除了、数据恢复、数据回补、平衡数据分布，并将数据相关的一些监控信息提供给Ceph Monitor，以便检查OSD心跳状态。

Monitor：Ceph的Monitor守护进程，主要功能是维护集群状态的表组。包含多张表，其中有Monitor map、OSD map、PG map、CRUSH map。

MDS：Ceph的MDS守护进程，主要保存的是Ceph文件系统的元数据。

**架构**

 ![1576724855](https://github.com/orangehaswing/HCIA-CloudComputing/blob/master/resources/1576724855.jpg?raw=true)

底层是RADOS，本质是一个对象存储。

 ![1576724919(1)](https://github.com/orangehaswing/HCIA-CloudComputing/blob/master/resources/1576724919(1).jpg?raw=true)

### CRUSH算法

CRUSH是一种基于可扩展哈希的控制复制算法。CRUSH是其中负责数据对象实际分布于数据恢复的算法。

**算法三要素**

Cluster Map：记录所有可用的存储资源及相互之间的空间层次架构。

Data Distribution Policy： 它由配置规则组成。配置规则决定了每个数据对象的副本份数，以及这些副本存储的限制条件(如3个副本放在不同的服务器中，或者不同的机架中)。

CRUSH算法：利用多参数Hash函数，参数含有x，使得从x到OSD集合是确定性的和独立的。

 ![1576726849(1)](https://github.com/orangehaswing/HCIA-CloudComputing/blob/master/resources/1576726849(1).jpg?raw=true)

## 虚拟化管理平台

### OpenStack

OpenStack组件：

- Keystone负责认证，用户管理工作
- Glance负责镜像管理
- Nova负责管理计算资源
- Neutron负责虚拟化网络的管理
- Cinder提供块存储服务
- Horizon是OpenStack的dashboard，提供通过网页管理OpenStack的功能
- Swift提供对象存储服务

### OpenNebula

OpenNebula用于构建和管理企业云及数据中心虚拟化。支持Xen，KVM，VMware ESX虚拟化引擎，可以一起混合建立和管理私有云，同时提供Deltacloud。

一个经典的OpenNebula集群至少需要一个前端和一个用于运行虚拟机的主机。在网络方面，至少需要一个物理网络，并且确保前端能和所有的主机连通。

![1576727459(1)](https://github.com/orangehaswing/HCIA-CloudComputing/blob/master/resources/1576727459(1).jpg?raw=true)

**OpenNebula组件**

- Front-End(前端)：用于运行OpenNebula服务
- Host(宿主机)：用于运行所有的虚拟机
- DataStores(数据存储)：用于实际存放虚拟机的硬盘
- NetWork(网络)：网络需要分为两部分，一部分连通OpenNebula集群中各组件，另一部分是为虚拟机提供的虚拟网络。

**前端**

服务器角色，包含诸多功能组件，如OpenNebula管理进程oned，调度器mm_sched，一个Web接口服务sunstone-server。各组件通过XML-RPC接口通信。

**宿主机**

宿主机用于运行虚拟机的服务器，OpenNebula支持多个虚拟化平台，目前主流的Xen，KVM，WMware都支持。

**数据存储**

用于存放虚拟机的硬盘文件，可以是任意一种存储介质，NAS(网络附加存储)，SAN(存储区域网络)，直连存储设备(宿主机本地硬盘)都可以作为OpenNebula的数据存储。可以细分为：系统数据存储，镜像数据存储，文件系统存储。

**网络**

定义两类不同网络。第一，服务网络。用于前端程序对宿主机进行管理，监控和镜像文件移动等操作，推荐的做法是建立单独的服务网络。第二，虚拟机实际网络，用于提供给虚拟机用的网络，通俗讲就是业务网络。

### 其他管理平台

**ConVirt**

理念是云管理平台，致力于在其他的云管理平台上构建一套标准接口，统一管理私有云，公有云，混合云。

**CloudStack**

由思杰公司维护。开发语言是Java，是IaaS层的解决方案。

采用"框架+插件"的系统架构，通过不同的插件来提供对不同虚拟化技术的支持。CloudStack本身是一个虚拟化管理平台，但是它通过CloudBridge提供与Amazon EC2相兼容的云管理接口，对外提供IaaS。

**oVirt**

主要使用场景是私有云管理，在架构设计上使用节点/引擎架构，专注于KVM，基于Web界面，易于搭建。

**WebVirtMgr**

比较活跃，非常清新的KVM管理平台。几乎是纯Python开发。









































































